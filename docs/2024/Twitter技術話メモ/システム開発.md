#

バックエンド開発者として大規模システムの構築を目指しているなら、水平スケーリング可能な分散システムを実際に構築するプロジェクトに取り組むことをお勧めします。このプロジェクトでは、CDN、ロードバランサー、ウェブアプリケーションサーバ、認証サービス、データベース、ファイルストレージなど、大規模システムの主要コンポーネントを実装します。

多くのシステム設計が仮想的なシナリオに基づいていますが、このプロジェクトは基本的なバックエンド知識があれば一人で実践できる、実用的なものです。また、分散システムの設計への入り口となるだけでなく、大企業のバックエンドでよく見られる大規模インフラを理解し、扱うために必要な全ての背景知識を提供します。

このシンプルでスケーラブルなプロジェクトの基本的な考え方は、アプリケーションのロジックを全て含むステートレスなアプリケーションを作成することです。つまり、状態を一切保持しません。ウェブアプリケーションをホストする各サーバにデータが紐づくことはありません。結果として、全てのアプリケーションはどこにデプロイされても全く同じ動作をします。

この考え方に基づいて、以下の4つの重要な要素を扱うことになります。

・CDN
静的コンテンツ、例えば画像や動画、PDF、生成済みのページなどは、ユーザーにより近い場所で提供できるよう、世界中に展開されたコンテンツ・デリバリー・ネットワーク（CDN）に保存するのが効果的です。

これらのコンテンツは頻繁に変更されないため、独自のCDNを構築することも可能です。例えば、適切な容量のストレージを持つサーバを5台ほど世界中に配置し、最近使用されたコンテンツを優先的に保存する「Least Recently Used」などのアルゴリズムを使って、各地域でアクセスの多いコンテンツをキャッシュするという方法があります。

ただし、各CDNノードの容量には限りがあるため、長期間アクセスのないデータは、新しくアクセスされたコンテンツによって置き換えられることもあります。

このようなCDNを利用すれば、キャッシュにヒットしたリクエストはメインサーバまで届く必要がなくなり、トラフィックを大幅に削減できます。もちろん、自前でCDNを構築する代わりに、既存のCDNサービスを利用するのも一つの選択肢です。

・ロードバランサーとウェブアプリサーバ
HTTPリクエストがサーバに到達した際、最初の受け口となるのはロードバランサーサーバです。このサーバは、ラウンドロビンなどのシンプルなアルゴリズムを使って、全てのステートレスサーバにトラフィックを均等に振り分けます。

これらのウェブアプリサーバは全て同じ機能を持ち、同じ方法でリクエストを処理します。サーバの数は必要に応じて増減が可能で、万が一一台がダウンしても簡単に交換できます。これはすべて、ステートレス設計の利点です。

処理の中でユーザー認証が必要な場合は認証サービスを呼び出し、ユーザーデータが必要ならデータベースサーバにアクセス、ファイルが必要な場合はファイルストレージサーバを利用します。

さらに、各サーバは自身のRAMストレージを使ってデータをキャッシュすることができます。ここでもLRUアルゴリズムを使うことで、データサーバへのアクセス回数を減らせます。また、より高速なデータ取得のために、メモリベースの専用キャッシュサーバを別途用意することも可能です。

・認証サービス
これは、ユーザーのサインインとアクセス権限の管理を行うための、全てのユーザー認証を処理するサービスです。認証方法にはいくつかの選択肢があります。

まず、HTTPクッキーとセッションを使用する方法があります。この場合、サービスは専用のサーバとして機能し、ログインしたユーザーのセッションIDキーを保存・確認します。

次に、ステートレストークンを使用する方法があります。この方法では、JWTなどのツールを使い、サーバサイドの秘密鍵で有効期限付きのトークンを生成します。クライアントはこのトークンをデバイスに安全に保存し、リクエストのたびにサーバに送信します。トークンにはユーザーIDやユーザー名などの情報を含めることができます。トークンの作成と検証はステートレスなので、秘密鍵さえ共有されていれば、個々のアプリケーションサーバでこの処理を行うことも、別のサーバに任せることも可能です。

最後に、OAuth等の外部サービスを利用して認証を行う方法もあります。

・データベースとファイルストレージ
これは、ユーザーデータ、ビジネスデータ、ユーザーファイル、生成されたコンテンツなど、状態を保存するアーキテクチャの一部です。ここで重要なのは、1台のサーバに物理的に格納できるデータの最大量（例えば100TB）と、1台のサーバが同時に処理できる読み書きの最大量です。そのため、データ層も水平方向に拡張する必要があります。

ファイルシステムの場合、この拡張は比較的簡単です。例えば、ユーザープロフィール用、請求書PDF用、動画用など、用途に応じて各ファイルストレージノードを分割できます。静的コンテンツはここに置かれ、主にCDNにキャッシュされていないコンテンツを提供します。

一方、データベースは構造化データを扱います。特にリレーショナルデータベースを使用し、テーブルをまたいでデータにアクセスする必要がある場合は、セットアップが複雑になります。これを処理する簡単な方法として、ユーザーIDに基づいてユーザーデータを分割し、全てのデータベースノードに均等に分散させる方法があります。これはデータベースシャーディングと呼ばれます。

アプリケーションの書き込みが少量で、保存データがそれほど多くなく、読み込みが大量にある場合は、マスター・スレーブ設計の方が実装が簡単です。全ての書き込みを単一のマスターデータベースノードで行い、そのデータをスレーブノードである他の全てのデータベースノードに転送し、全ての読み込みをスレーブデータベースノードで行うことができます。より高度な設計では、これらの手法を組み合わせて使用します。

最後に、データのバックアップも忘れてはいけません。オフラインで安全に保存したり、ネットワーク上で積極的にバックアップを必要としない場合は、比較的シンプルな方法でバックアップを行うことができます。

最低限のシステムを構築するには、各コンポーネントごとに少なくとも1台のサーバノードが必要です。これらのサーバは、クラウドサービスを利用してインスタンスを生成する方法もありますし、教育目的であれば、Raspberry PiやJetson Nanoのようなミニコンピュータを使って、自前の小規模なデータセンターを構築することもできます。

理想的には、各サーバノードは同じ物理ネットワーク上に配置し、レイテンシーを最小限に抑えることが望ましいです。ただし、このプロジェクトの最終的な目標は、水平スケーリングを実際に体験することにあります。

技術スタックとしては、NGINX、好みのバックエンド言語、MySQL、memcachedをおすすめします。NGINXを使えば、アプリケーションサーバ用のロードバランサーをセットアップできますし、必要に応じてデータベースのセットアップもできます。

ウェブアプリケーションは、最も使い慣れている言語を選ぶのが良いと思います。シンプルさを重視するならGoやNode.jsがおすすめですが、ビジネスロジックに多くの機能が必要な場合は、状態管理に別のドライバを使用できる限り、フレームワークを利用した方が開発速度を上げれます。

MySQLには、レプリケーションとバックアップに必要な機能が揃っています。また、memcachedはメモリベースのLRUアルゴリズムを使用したキーバリューペアのキャッシュを提供しています。

https://x.com/jalva_dev/status/1804711044625174652